import os
import json

################################################################################
# start of functions
################################################################################

###
# process the GET request
# @param  {Object} json_data
# @return          the string need to be written to the file
def process_get(json_data):
	result = ''

	action = json_data['action']
	query = []
	for key, value in json_data['parameter'].iteritems():
		query.append(key + '=' + value)

	result += 'browser.get("'
	result += action + '?' + '&'.join(query)
	result += '")\n'
	return result

###
# process the POST request
# @param  {Object} json_data
# @return          the string need to be written to the file
def process_post(json_data):

	def execute_script(js_code_string):
		return 'browser.execute_script("""\n' + js_code_string + '\n""")\n'

	result = ''
	# create a form element
	result += 'var form = document.createElement("form");\n'
	result += 'form.setAttribute("method", "POST");\n'
	result += 'form.setAttribute("action", "' + json_data['action'] + '");\n'
	# create and append each field of the form
	result += 'var field;\n'
	for key, value in json_data['parameter'].iteritems():
		result += 'field = document.createElement("input");\n'
		result += 'field.setAttribute("name", "' + key + '");\n'
		result += 'field.setAttribute("value", "' + value + '");\n'
		result += 'form.appendChild(field);\n'
	# submit the form
	result += 'document.body.appendChild(form);\n'
	result += 'form.submit();'

	return execute_script(result)

###
# generate the exploit scripts
# @param  {String} file_path
# @param  {Object} json_config
# @param  {Object} json_data
# @return          the string need to be written to the file
def generate_exploit_script(file_path, json_config, json_data):
	file = open(file_path, 'w')

	file.write('from selenium import webdriver\n\n')

	file.write('browser = webdriver.Firefox()\n\n')

	# login first
	file.write('browser.get("' + json_config['login_url'] + '")\n')
	file.write('print browser.title\n\n')

	file.write('username = browser.find_element_by_name("username")\n')
	file.write('username.send_keys("' + json_config['username'] + '")\n')
	file.write('password = browser.find_element_by_name("password")\n')
	file.write('password.send_keys("' + json_config['password'] + '")\n')
	file.write('password.submit()\n\n')

	# perform attack operation
	if json_data['method'].lower() == 'get':
		# print 'Process GET'
		file.write(process_get(json_data))
	elif json_data['method'].lower() == 'post':
		# print 'Process POST'
		file.write(process_post(json_data))
	else:
		print 'Unknown action: ' + json_data['method']

	# file.write('browser.quit()')

	file.close()

################################################################################
# end of functions
################################################################################

# check the output dir and clean it if it exists
output_dir = 'out'
if os.path.exists(output_dir):
	for file in os.listdir(output_dir):
		os.remove(output_dir + '/' + file)
		print 'Removed file: ' + output_dir + '/' + file
else:
	os.makedirs(output_dir)

# read config
config_file_path = '../config.json'
with open(config_file_path) as config_file:
	config = json.load(config_file)


counter = 1
with open('../phase2&3/phase3.json') as data_file:
	data = json.load(data_file)

for obj in data:
	file_name = 'exploit_script_' + `counter` + '.py'
	generate_exploit_script(output_dir + '/' + file_name, config, obj)
	print 'Generated script: ' + output_dir + '/' + file_name
	counter += 1

