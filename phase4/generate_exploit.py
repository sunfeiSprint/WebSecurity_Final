import os
import json

output_dir = 'out'
if os.path.exists(output_dir):
	for file in os.listdir(output_dir):
		os.remove(output_dir + '/' + file)
		print 'Removed file: ' + output_dir + '/' + file
else:
	os.makedirs(output_dir)


###
# process the GET request
# @param  {Object} json_data
# @return          the string need to be written to the file
def process_get(json_data):
	result = ''

	action = json_data['action']
	query = []
	for key, value in json_data['parameter'].iteritems():
		query.append(key + '=' + value)

	result += 'browser.get("'
	result += action + '?' + '&'.join(query)
	result += '")\n\n'
	return result

###
# process the POST request
# @param  {Object} json_data
# @return          the string need to be written to the file
def process_post(json_data):
	result = ''

	result += 'browser.execute_script(\''
	# create a form element
	result += 'var form = document.createElement("form");'
	result += 'form.setAttribute("method", "POST");'
	result += 'form.setAttribute("action", "' + json_data['action'] + '");'
	# create and append each field of the form
	result += 'var field;'
	for key, value in json_data['parameter'].iteritems():
		result += 'field = document.createElement("input");'
		result += 'field.setAttribute("name", "' + key + '");'
		result += 'field.setAttribute("value", "' + value + '");'
		result += 'form.appendChild(field);'

	result += 'document.body.appendChild(form);'
	result += 'form.submit();'

	result += '\')\n\n'

	return result

###
# generate the exploit scripts
# @param  {String} file_name
# @param  {Object} json_config
# @param  {Object} json_data
# @return          the string need to be written to the file
def generate_exploit_script(file_name, json_config, json_data):
	file = open(output_dir + '/' + file_name, 'w')

	file.write('from selenium import webdriver\n\n')

	file.write('browser = webdriver.Firefox()\n\n')

	# login first
	file.write('browser.get("' + json_config['login_url'] + '")\n')
	file.write('print browser.title\n\n')

	file.write('username = browser.find_element_by_name("username")\n')
	file.write('username.send_keys("' + json_config['username'] + '")\n')
	file.write('password = browser.find_element_by_name("password")\n')
	file.write('password.send_keys("' + json_config['password'] + '")\n')
	file.write('password.submit()\n\n')

	# perform attack operation
	if json_data['method'].lower() == 'get':
		# print 'Process GET'
		file.write(process_get(json_data))
	elif json_data['method'].lower() == 'post':
		# print 'Process POST'
		file.write(process_post(json_data))
	else:
		print 'Unknown action: ' + json_data['method']

	# file.write('browser.quit()')

	file.close()

################################################################################
# end of functions
################################################################################

# read config
config_file_path = '../config.json'
with open(config_file_path) as config_file:
	config = json.load(config_file)


counter = 1
with open('../phase2&3/phase3.json') as data_file:
	data = json.load(data_file)

for obj in data:
	file_name = 'exploit_script_' + `counter` + '.py'
	generate_exploit_script(file_name, config, obj)
	print 'Generated script: ' + output_dir + '/' + file_name
	counter += 1

